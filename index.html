<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>De Montfort Hall — Busy Show Periods</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#12131a; --muted:#b0b4c0; --text:#f2f4f8; --accent:#8ab4f8;
      --quiet:#3a5f0b; --moderate:#b38600; --busy:#b00020; --sold:#7c1a1a; --grid:#1e2030;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial,sans-serif;background:var(--bg);color:var(--text);}
    header{position:sticky;top:0;background:rgba(11,12,16,.8);backdrop-filter:blur(8px);border-bottom:1px solid #222;padding:16px 20px;z-index:5}
    h1{margin:0;font-size:20px;letter-spacing:.3px}
    main{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;gap:16px;grid-template-columns:1.2fr .8fr}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid #222;border-radius:16px;box-shadow:0 6px 16px rgba(0,0,0,.25)}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .card .head{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #222}
    .card .body{padding:14px 16px}

    .controls{display:flex;gap:8px;flex-wrap:wrap}
    button, select, input[type="month"]{background:#171923;border:1px solid #2a2d3a;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}

    .legend{display:flex;gap:12px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .legend span{display:inline-flex;gap:6px;align-items:center}
    .dot{width:12px;height:12px;border-radius:3px;display:inline-block}

    /* Calendar */
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .weekday{font-size:12px;color:var(--muted);text-align:center}
    .day{background:var(--grid);border:1px solid #2a2d3a;border-radius:10px;min-height:68px;padding:6px;display:flex;flex-direction:column;gap:6px}
    .day .date{font-size:12px;color:var(--muted)}
    .bar{height:6px;border-radius:4px;background:#253136}
    .tag{font-size:11px;padding:3px 6px;border-radius:999px;display:inline-block;border:1px solid #2a2d3a;color:#d7dbe7}

    /* Event list */
    .events{display:flex;flex-direction:column;gap:10px}
    .event{display:flex;gap:10px;justify-content:space-between;align-items:baseline;border:1px solid #24273a;border-radius:12px;padding:10px;background:#161826}
    .event .title{font-weight:600}
    .event .meta{font-size:12px;color:var(--muted)}

    /* Busy periods */
    .period{padding:10px;border-radius:12px;border:1px solid #2a2d3a;background:#141726}

    .footer{margin:32px 0;color:var(--muted);font-size:12px}
    .muted{color:var(--muted)}
    details{background:#10121b;border:1px solid #24273a;border-radius:12px;padding:10px}
    textarea{width:100%;min-height:160px;background:#0d0f16;color:var(--text);border:1px solid #24273a;border-radius:12px;padding:10px}
    .pill{font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #2a2d3a}
  </style>
</head>
<body>
  <header>
    <h1>De Montfort Hall — Busy Show Periods</h1>
  </header>
  <main>
    <div class="grid">
      <!-- Left: Calendar + Periods -->
      <section class="card">
        <div class="head">
          <h2>Calendar heatmap</h2>
          <div class="controls">
            <input type="month" id="monthPicker" />
            <button id="prevBtn" title="Previous month">◀</button>
            <button id="nextBtn" title="Next month">▶</button>
          </div>
        </div>
        <div class="body">
          <div class="legend" style="margin-bottom:10px">
            <span><span class="dot" style="background:var(--quiet)"></span>Quiet</span>
            <span><span class="dot" style="background:var(--moderate)"></span>Moderate</span>
            <span><span class="dot" style="background:var(--busy)"></span>Busy</span>
            <span><span class="dot" style="background:var(--sold)"></span>Sold out</span>
            <span class="muted">Intensity reflects the combined load of scheduled shows and ticket uptake.</span>
          </div>
          <div id="monthLabel" class="muted" style="margin:6px 0 10px 2px"></div>
          <div class="calendar" id="calendar"></div>
        </div>
      </section>

      <!-- Right: List + Import -->
      <section class="card">
        <div class="head">
          <h2>Shows</h2>
          <div class="controls">
            <select id="sortSelect" title="Sort">
              <option value="date">Sort: Date</option>
              <option value="busyness">Sort: Busyness</option>
              <option value="title">Sort: Title</option>
            </select>
          </div>
        </div>
        <div class="body">
          <div class="events" id="events"></div>
          <hr style="border:0;border-top:1px solid #24273a;margin:14px 0;opacity:.7" />
          <details>
            <summary><strong>Paste/Import data</strong> (JSON)</summary>
            <p class="muted">Paste an array of events with <code>title</code>, <code>start</code> (ISO date), optional <code>end</code>, <code>tickets_total</code>, <code>tickets_sold</code>. Then click Import.</p>
            <textarea id="jsonInput" placeholder='[
  {"title":"Example Show","start":"2025-10-18","tickets_total":2000,"tickets_sold":1400},
  {"title":"Another","start":"2025-10-19T19:30:00","tickets_total":1500,"tickets_sold":1490}
]'></textarea>
            <div class="controls" style="margin-top:8px">
              <button id="importBtn">Import</button>
              <button id="resetBtn" title="Restore sample data">Reset sample</button>
              <a id="exportBtn" href="#" class="pill" download="dmh-events.json">Export</a>
            </div>
          </details>
        </div>
      </section>

      <!-- Busy periods card -->
      <section class="card" style="grid-column:1 / -1">
        <div class="head">
          <h2>Detected busy periods</h2>
          <div class="controls">
            <select id="windowSelect">
              <option value="7">Window: 7 days</option>
              <option value="14">Window: 14 days</option>
              <option value="30">Window: 30 days</option>
            </select>
          </div>
        </div>
        <div class="body">
          <div id="periods"></div>
        </div>
      </section>
    </div>

    <p class="footer"><strong>Data note:</strong> De Montfort Hall does not publish exact tickets‑sold figures. This page estimates busyness from the event status shown on their site (e.g., “SOLD OUT”, “BOOK NOW”). Paste your own data in the Import box or wire this page to a backend that scrapes/aggregates statuses.</p>
  </main>

  <script>
    // ---------------------------
    // Utility helpers
    // ---------------------------
    const fmt = new Intl.DateTimeFormat(undefined,{year:'numeric',month:'long',day:'numeric'});
    const fmtShort = new Intl.DateTimeFormat(undefined,{month:'short',day:'2-digit'});
    const fmtTime = new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit'});

    function occupancy(ev){
      if(ev.tickets_total && ev.tickets_total>0){
        return clamp((ev.tickets_sold||0)/Math.max(1,ev.tickets_total),0,1);
      }
      const s=(ev.status||'').toLowerCase();
      if(s.includes('sold')) return 1.0;
      if(s.includes('limited')) return 0.85;
      if(s.includes('last')||s.includes('low')) return 0.75;
      if(s.includes('book now')) return 0.45;
      return 0.30; // unknown -> quiet/moderate
    }

    function parseDate(d){ return d ? new Date(d) : null; }
    function toLocalKey(d){ const y=d.getFullYear(); const m=(d.getMonth()+1).toString().padStart(2,'0'); const day=d.getDate().toString().padStart(2,'0'); return `${y}-${m}-${day}`; }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    // Score an event: occupancy + a small boost for imminent shows
    function eventScore(ev){
      const occ = occupancy(ev);
      const daysAway = Math.floor((parseDate(ev.start) - new Date())/86400000);
      const urgency = daysAway <= 14 ? (14 - Math.max(0,daysAway)) / 14 * 0.25 : 0; // up to +0.25
      return occ + urgency; // 0..1.25
    }

    function busynessLabel(pct){
      if(pct >= 0.99) return ['Sold out','var(--sold)'];
      if(pct >= 0.85) return ['Very busy','var(--busy)'];
      if(pct >= 0.60) return ['Busy','var(--moderate)'];
      if(pct >= 0.40) return ['Moderate','var(--moderate)'];
      return ['Quiet','var(--quiet)'];
    }

    // ---------------------------
    // Sample data (real status pulled from DMH site pages on Oct 3, 2025)
    // Note: exact tickets-sold counts are not public; we proxy busyness from page status.
    // ---------------------------
    const SAMPLE = [
      { title: "Level 42", start: "2025-10-06T19:00:00", status: "SOLD OUT" },
      { title: "Miriam Margolyes", start: "2025-10-23T19:30:00", status: "SOLD OUT" },
      { title: "Fisherman's Friends", start: "2025-10-25T19:00:00", status: "SOLD OUT" },
      { title: "The Return Of The Legends", start: "2025-10-13T19:30:00", status: "BOOK NOW" },
      { title: "An Evening With The Fast Show", start: "2025-12-02T19:30:00", status: "SOLD OUT" }
    ];

    let state = { events: [...SAMPLE], month: new Date(new Date().getFullYear(), new Date().getMonth(), 1) };

    // ---------------------------
    // Rendering
    // ---------------------------
    const monthPicker = document.getElementById('monthPicker');
    const calendar = document.getElementById('calendar');
    const monthLabel = document.getElementById('monthLabel');
    const eventsEl = document.getElementById('events');
    const periodsEl = document.getElementById('periods');

    function setMonthInput(d){
      const y = d.getFullYear();
      const m = (d.getMonth()+1).toString().padStart(2,'0');
      monthPicker.value = `${y}-${m}`;
      monthLabel.textContent = d.toLocaleString(undefined,{month:'long',year:'numeric'});
    }

    function monthMatrix(date){
      const y = date.getFullYear();
      const m = date.getMonth();
      const first = new Date(y,m,1);
      const startOffset = (first.getDay()+6)%7; // make Monday=0
      const daysInMonth = new Date(y,m+1,0).getDate();
      const cells = [];
      for(let i=0;i<startOffset;i++) cells.push(null);
      for(let d=1; d<=daysInMonth; d++){ cells.push(new Date(y,m,d)); }
      while(cells.length % 7 !== 0) cells.push(null);
      return cells;
    }

    function buildDayScores(events){
      const map = new Map();
      for(const ev of events){
        const d = new Date(ev.start);
        const key = toLocalKey(d);
        const prev = map.get(key)||[];
        prev.push(occupancy(ev));
        map.set(key, prev);
      }
      return map; // key -> array of occupancies for that day
    }

    function renderCalendar(){
      calendar.innerHTML = '';
      const days = monthMatrix(state.month);
      const dayOccs = buildDayScores(state.events);

      // Weekday headers
      const names=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      names.forEach(n=>{
        const w = document.createElement('div');
        w.className='weekday';
        w.textContent=n;
        calendar.appendChild(w);
      });

      for(const d of days){
        const cell = document.createElement('div');
        cell.className='day';
        if(d){
          const key = toLocalKey(d);
          const occs = dayOccs.get(key)||[];
          const avgOcc = occs.length ? occs.reduce((a,b)=>a+b,0)/occs.length : 0;
          const [label,color] = busynessLabel(avgOcc);

          const dateEl=document.createElement('div'); dateEl.className='date'; dateEl.textContent = fmtShort.format(d);
          const pct = Math.round(avgOcc*100);
          const bar=document.createElement('div'); bar.className='bar'; bar.style.background = `linear-gradient(90deg, ${getColor(avgOcc)} ${pct}%, #253136 ${pct}%)`;
          const tag=document.createElement('span'); tag.className='tag'; tag.style.borderColor='rgba(255,255,255,.08)'; tag.style.background='rgba(255,255,255,.03)'; tag.style.color='#dfe3ee'; tag.textContent=label + (occs.length?` · ${occs.length} show${occs.length>1?'s':''}`:'');

          cell.appendChild(dateEl);
          cell.appendChild(bar);
          cell.appendChild(tag);
          const eventsToday = state.events.filter(e=>toLocalKey(new Date(e.start))===key);
          cell.title = eventsToday.map(e=>`$\{e.title} — $\{fmt.format(new Date(e.start))}`).join('\n');
        } else {
          cell.style.visibility='hidden';
        }
        calendar.appendChild(cell);
      }
    }

    function getColor(pct){
      if(pct>=0.99) return getComputedStyle(document.documentElement).getPropertyValue('--sold');
      if(pct>=0.75) return getComputedStyle(document.documentElement).getPropertyValue('--busy');
      if(pct>=0.40) return getComputedStyle(document.documentElement).getPropertyValue('--moderate');
      return getComputedStyle(document.documentElement).getPropertyValue('--quiet');
    }

    function renderEvents(){
      eventsEl.innerHTML='';
      const sort = document.getElementById('sortSelect').value;
      const arr = [...state.events];
      arr.sort((a,b)=>{
        if(sort==='busyness') return eventScore(b)-eventScore(a);
        if(sort==='title') return a.title.localeCompare(b.title);
        return new Date(a.start)-new Date(b.start);
      });

      for(const ev of arr){
        const wrap = document.createElement('div'); wrap.className='event';
        const left = document.createElement('div');
        const right = document.createElement('div');

        const title = document.createElement('div'); title.className='title'; title.textContent = ev.title;
        const dt = parseDate(ev.start);
        const when = document.createElement('div'); when.className='meta';
        when.textContent = `${fmt.format(dt)}${ev.start.includes('T')?` · ${fmtTime.format(dt)}`:''}`;

        const pct = occupancy(ev);
        const [label,color] = busynessLabel(pct);
        const pill = document.createElement('span'); pill.className='pill'; pill.textContent=`${label}${ev.status?` · ${ev.status}`:''} · ${(pct*100).toFixed(0)}%`; pill.style.borderColor=color; pill.style.color=color;

        left.appendChild(title); left.appendChild(when);
        right.appendChild(pill);
        wrap.appendChild(left); wrap.appendChild(right);
        eventsEl.appendChild(wrap);
      }

      // update export link
      const blob = new Blob([JSON.stringify(state.events,null,2)], {type:'application/json'});
      document.getElementById('exportBtn').href = URL.createObjectURL(blob);
    }

    function detectBusyPeriods(windowDays=7){
      // Aggregate by day: sum occupancy percentages as load
      const byDay = new Map();
      for(const ev of state.events){
        const key = toLocalKey(new Date(ev.start));
        const load = occupancy(ev);
        byDay.set(key, (byDay.get(key)||0) + load);
      }
      // Build sorted unique days
      const days = [...byDay.keys()].sort();
      const toDate = k=>new Date(k+"T00:00:00");

      const results=[];
      for(let i=0;i<days.length;i++){
        const start = toDate(days[i]);
        const end = new Date(start.getTime() + (windowDays-1)*86400000);
        let sum=0, count=0;
        for(const k of days){
          const d = toDate(k);
          if(d>=start && d<=end){ sum += byDay.get(k); count++; }
        }
        const avg = count? sum/count : 0;
        if(avg >= 1.0 || sum >= windowDays*0.8){ // heuristic thresholds tuned for status-based data
          results.push({start, end, avg: Number(avg.toFixed(2)), sum: Number(sum.toFixed(2))});
        }
      }
      // Merge overlapping periods
      results.sort((a,b)=>a.start-b.start);
      const merged=[];
      for(const r of results){
        const last = merged[merged.length-1];
        if(last && r.start <= last.end){
          last.end = new Date(Math.max(last.end, r.end));
          last.avg = Number(((last.avg + r.avg)/2).toFixed(2));
          last.sum = Number((last.sum + r.sum).toFixed(2));
        } else merged.push(r);
      }
      return merged;
    }

    function renderPeriods(){
      periodsEl.innerHTML='';
      const win = parseInt(document.getElementById('windowSelect').value,10);
      const periods = detectBusyPeriods(win);
      if(!periods.length){
        const p=document.createElement('p'); p.className='muted'; p.textContent='No high‑load periods detected for the selected window.'; periodsEl.appendChild(p); return;
      }
      for(const p of periods){
        const div=document.createElement('div'); div.className='period';
        const rng=`${fmt.format(p.start)} → ${fmt.format(p.end)}`;
        const level = p.avg>=1.5?['Very busy','var(--busy)']: p.avg>=1.0?['Busy','var(--moderate)']:['Moderate','var(--quiet)'];
        div.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px;align-items:baseline">
          <div><strong>${level[0]}</strong> · ${rng}</div>
          <span class="pill" style="border-color:${level[1]};color:${level[1]}">avg load ${p.avg}, total ${p.sum}</span>
        </div>`;
        periodsEl.appendChild(div);
      }
    }

    // ---------------------------
    // Wiring
    // ---------------------------
    document.getElementById('prevBtn').onclick = ()=>{ state.month = new Date(state.month.getFullYear(), state.month.getMonth()-1, 1); setMonthInput(state.month); renderCalendar(); };
    document.getElementById('nextBtn').onclick = ()=>{ state.month = new Date(state.month.getFullYear(), state.month.getMonth()+1, 1); setMonthInput(state.month); renderCalendar(); };
    monthPicker.onchange = (e)=>{ const [y,m]=e.target.value.split('-').map(Number); state.month = new Date(y, m-1, 1); setMonthInput(state.month); renderCalendar(); };
    document.getElementById('sortSelect').onchange = ()=> renderEvents();
    document.getElementById('windowSelect').onchange = ()=> renderPeriods();

    document.getElementById('importBtn').onclick = ()=>{
      try{
        const arr = JSON.parse(document.getElementById('jsonInput').value);
        if(!Array.isArray(arr)) throw new Error('JSON must be an array of events');
        state.events = arr.map(e=>({
          title: e.title||'Untitled',
          start: e.start,
          end: e.end||e.start,
          tickets_total: e.tickets_total||0,
          tickets_sold: e.tickets_sold||0,
          status: e.status||e.availability||'' ,
        })).filter(e=>e.start);
        renderAll();
      }catch(err){ alert('Import failed: '+ err.message); }
    };

    document.getElementById('resetBtn').onclick = ()=>{ state.events=[...SAMPLE]; renderAll(); };

    function renderAll(){ setMonthInput(state.month); renderCalendar(); renderEvents(); renderPeriods(); }

    // Init
    renderAll();
  </script>
</body>
</html>
